<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />
  <title>Azure Functions and FastAPI - Max Scheijen</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" href="../../theme/css/main.css" type="text/css" />
  <link rel="stylesheet" href="../../theme/css/syntax.css" type="text/css" />
  <link rel="icon" type="image/png" sizes="16x16" href="../../theme/images/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../../theme/images/favicon-32x32.png">
  
  <link href="../../feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Max Scheijen - Flux ATOM" />
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-DC0740CRYY"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', "G-DC0740CRYY");
  </script>
</head>
<body>
  <main>
        
  <h1>Azure Functions and FastAPI</h1>
  <a href="/" class="by">Dec 14, 2024 - By Max Scheijen</a>
  <div class="meta">
    <!-- <p>Dec 14, 2024</p> -->
    <!-- <p></p> -->
  </div>
  <article>
  <p>I'm a huge fan of <a href="https://fastapi.tiangolo.com">FastAPI</a>. It's a high-performance web framework for building APIs in Python, based on type hints and Pydantic, which enables automatic documentation and data validation.</p>
<p>At work, we extensively use <a href="https://learn.microsoft.com/en-us/azure/azure-functions/">Azure Functions</a>. These are serverless resources that reduce the need for infrastructure configuration and maintenance, allowing us to focus more on writing code. To create Azure Functions in Python, we can use the <a href="https://pypi.org/project/azure-functions/">azure-functions</a> package.</p>
<p>However, I really love FastAPI as a framework for building APIs. Let's explore how we can create an Azure Function leveraging FastAPI.</p>
<h2>Setup</h2>
<p>Let's start by setting up the following project structure:</p>
<div class="highlight"><pre><span></span><code>azure-function-fastapi
├── api
│   └── __init__.py
├── function_app.py
├── host.json
└── local.settings.json
</code></pre></div>

<p>Where:</p>
<ul>
<li><code>function_app.py</code> is the Azure Function entry point</li>
<li><code>__init__.py</code> is where we create our FastAPI app</li>
<li><code>host.json</code> defines global settings and behaviors</li>
<li><code>local.settings.json</code> contains settings used for local running and debugging</li>
</ul>
<h2>Creating a FastAPI App</h2>
<p>Let's build our FastAPI app in <code>__init__.py</code>. This can be done exactly as you would normally create a FastAPI application:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
  <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/hello/</span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>

<p>This creates a parameterized route (<code>/hello/{name}</code>) that dynamically accepts a value in the URL path and returns a JSON response (<code>User</code>).</p>
<p>You can run this app from the root using:</p>
<div class="highlight"><pre><span></span><code>uvicorn<span class="w"> </span>api.__init__:app
</code></pre></div>

<p>Let's make a <code>GET</code> request using <code>curl</code> to our API:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>http://127.0.0.1:8000/hello/Max
</code></pre></div>

<p>Response</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Max&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p>Automatic documentation can be found at <code>[http://127.0.0.1:8000/docs](http://127.0.0.1:8000/docs)</code>.</p>
<h2>Integrating in Azure Function</h2>
<p>Integrating the FastAPI app into an Azure Function is straightforward:</p>
<p>Add the following to <code>function_app.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">azure.functions</span> <span class="kn">import</span> <span class="n">AsgiFunctionApp</span><span class="p">,</span> <span class="n">AuthLevel</span>

<span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">app</span> <span class="k">as</span> <span class="n">fastapi_app</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">AsgiFunctionApp</span><span class="p">(</span>
  <span class="n">app</span><span class="o">=</span><span class="n">fastapi_app</span><span class="p">,</span>
  <span class="n">http_auth_level</span><span class="o">=</span><span class="n">AuthLevel</span><span class="o">.</span><span class="n">ANONYMOUS</span>
<span class="p">)</span>
</code></pre></div>

<p>We simply import our FastAPI app and use it in <code>AsgiFunctionApp</code>. It's that simple.</p>
<p>Next, set the function app settings in <code>host.json</code>:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;logging&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;applicationInsights&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;samplingSettings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;isEnabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;excludedTypes&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Request&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;extensionBundle&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Microsoft.Azure.Functions.ExtensionBundle&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;[2.*, 3.0.0)&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;extensions&quot;</span><span class="p">:</span><span class="w"> </span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;http&quot;</span><span class="p">:</span><span class="w"> </span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;routePrefix&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Define the local settings in <code>local.settings.json</code> for running the function app locally:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;IsEncrypted&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;Values&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;AzureWebJobsStorage&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;FUNCTIONS_WORKER_RUNTIME&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;AzureWebJobsFeatureFlags&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;EnableWorkerIndexing&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>You can now start the function app locally:</p>
<div class="highlight"><pre><span></span><code>func<span class="w"> </span>host<span class="w"> </span>start
</code></pre></div>

<p>You now have a FastAPI app running in an Azure Function!</p>
<blockquote>
<p><strong>Tip</strong>: You can still run your FastAPI app without the azure function, which can be helpful during development:</p>
</blockquote>
<div class="highlight"><pre><span></span><code>uvicorn<span class="w"> </span>api.__init__:app<span class="w"> </span>--reload
</code></pre></div>
  </article>
  </main>
</body>
</html>