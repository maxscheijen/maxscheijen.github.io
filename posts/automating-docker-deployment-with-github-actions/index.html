<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />
  <title>Automating Docker Deployment with Github Actions - Max Scheijen</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" href="../../theme/css/main.css" type="text/css" />
  <link rel="stylesheet" href="../../theme/css/syntax.css" type="text/css" />
  <link rel="icon" type="image/png" sizes="16x16" href="../../theme/images/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../../theme/images/favicon-32x32.png">
  
  <link href="../../feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Max Scheijen - Flux ATOM" />
  <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=G-DC0740CRYY"></script> -->
  <!-- <script> -->
  <!--   window.dataLayer = window.dataLayer || []; -->
  <!--   function gtag(){dataLayer.push(arguments);} -->
  <!--   gtag('js', new Date()); -->
  <!---->
  <!--   gtag('config', "G-DC0740CRYY"); -->
  <!-- </script> -->
</head>
<body>
  <main>
        
  <h1>Automating Docker Deployment with Github Actions</h1>
  <a href="/" class="by">Jan 18, 2025 - By Max Scheijen</a>
  <div class="meta">
    <!-- <p>Jan 18, 2025</p> -->
    <!-- <p></p> -->
  </div>
  <article>
  <p>As developers, we often need to deploy applications to server environments.</p>
<p>In this guide, I'll show you how to automate Docker container deployments using <a href="https://github.com/features/actions">GitHub Actions</a>, <a href="https://hub.docker.com">Docker Hub</a>, and a simple cron job. Whether you're new to Docker or looking to streamline your deployment process, this tutorial will walk you through both <strong>manual</strong> and <strong>automated</strong> approaches.</p>
<h2>Part 1: The Manual Process</h2>
<p>Before building an Docker image, we setup a simple web server in <code>main.py</code> with two endpoints using <a href="https://fastapi.tiangolo.com">FastAPI</a>.</p>
<p>This is just for demo purposes you can use whatever you like.</p>
<h3>1. Creating a Sample FastAPI Application</h3>
<p>First, let's create a minimal web server using <a href="https://fastapi.tiangolo.com">FastAPI</a>. </p>
<p>Create a <code>main.py</code> file:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">root</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;Hello World!!&quot;</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/</span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Hello </span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

<p>You can test this locally by running:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Install dependencies</span>
pip<span class="w"> </span>install<span class="w"> </span>fastapi<span class="w"> </span>uvicorn

<span class="c1"># Run server</span>
uvicorn<span class="w"> </span>main:app
</code></pre></div>

<h3>2. Containerizing the Application</h3>
<p>We now want containerize the application. Create <code>Dockerfile</code> that packages the application:</p>
<div class="highlight"><pre><span></span><code><span class="c"># Use a Python image</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.12</span><span class="w"> </span>

<span class="c"># Install the project into `/app`</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="c"># Install dependencies</span>
<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>fastapi<span class="w"> </span>uvicorn<span class="w"> </span>

<span class="c"># Copy the application code</span>
<span class="k">COPY</span><span class="w"> </span>.<span class="w"> </span>/app

<span class="c"># Expose the port and start the server</span>
<span class="k">EXPOSE</span><span class="w"> </span><span class="s">8000</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;uvicorn&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;main:app&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--host&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">]</span>
</code></pre></div>

<h3>3. Building and Publishing the Container</h3>
<p>To build the Docker image and get the container into production you need to:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Build the image</span>
docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>my-username/my-image<span class="w"> </span>.

<span class="c1"># Run and test the container locally</span>
docker<span class="w"> </span>run<span class="w"> </span>--name<span class="w"> </span>container-name<span class="w"> </span>-p<span class="w"> </span><span class="m">8000</span>:8000<span class="w"> </span>my-username/my-image

<span class="c1"># Push to Docker Hub</span>
docker<span class="w"> </span>push<span class="w"> </span>my-username/my-image
</code></pre></div>

<h3>4. Setting Up Docker on Your Server</h3>
<p>Here are the commands you'll need to setup Docker on a Debian-based server. Straight from the Docker <a href="https://docs.docker.com/engine/install/">documentation</a>.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Remove old versions</span>
<span class="k">for</span><span class="w"> </span>pkg<span class="w"> </span><span class="k">in</span><span class="w"> </span>docker.io<span class="w"> </span>docker-doc<span class="w"> </span>docker-compose<span class="w"> </span>podman-docker<span class="w"> </span>containerd<span class="w"> </span>runc<span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>sudo<span class="w"> </span>apt-get<span class="w"> </span>remove<span class="w"> </span><span class="nv">$pkg</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>

<span class="c1"># Install prerequisites</span>
sudo<span class="w"> </span>apt-get<span class="w"> </span>update
sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>ca-certificates<span class="w"> </span>curl
sudo<span class="w"> </span>install<span class="w"> </span>-m<span class="w"> </span><span class="m">0755</span><span class="w"> </span>-d<span class="w"> </span>/etc/apt/keyrings

<span class="c1"># Add Docker&#39;s PGP key and repository</span>
sudo<span class="w"> </span>curl<span class="w"> </span>-fsSL<span class="w"> </span>https://download.docker.com/linux/debian/gpg<span class="w"> </span>-o<span class="w"> </span>/etc/apt/keyrings/docker.asc
sudo<span class="w"> </span>chmod<span class="w"> </span>a+r<span class="w"> </span>/etc/apt/keyrings/docker.asc

<span class="c1"># Add the repository sources:</span>
<span class="nb">echo</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s2">&quot;deb [arch=</span><span class="k">$(</span>dpkg<span class="w"> </span>--print-architecture<span class="k">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \</span>
<span class="s2">  </span><span class="k">$(</span>.<span class="w"> </span>/etc/os-release<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$VERSION_CODENAME</span><span class="s2">&quot;</span><span class="k">)</span><span class="s2"> stable&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/docker.list<span class="w"> </span>&gt;<span class="w"> </span>/dev/null

<span class="c1"># Install Docker</span>
sudo<span class="w"> </span>apt-get<span class="w"> </span>update
sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>docker-ce<span class="w"> </span>docker-ce-cli<span class="w"> </span>containerd.io<span class="w"> </span>docker-buildx-plugin<span class="w"> </span>docker-compose-plugin

<span class="c1"># Setup non-root access</span>
sudo<span class="w"> </span>groupadd<span class="w"> </span>docker
sudo<span class="w"> </span>usermod<span class="w"> </span>-aG<span class="w"> </span>docker<span class="w"> </span><span class="nv">$USER</span>
</code></pre></div>

<blockquote>
<p>Remember to log out and back in for the group changes to take effect.</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1"># Pull the image</span>
docker<span class="w"> </span>pull<span class="w"> </span>my-username/my-image

<span class="c1"># Run the container</span>
docker<span class="w"> </span>run<span class="w"> </span>--name<span class="w"> </span>container-name<span class="w"> </span>-p<span class="w"> </span><span class="m">8000</span>:8000<span class="w"> </span>my-username/my-image
</code></pre></div>

<h2>Part 2: Automating the Process</h2>
<p>Now let's automate everything we did manually. We'll use GitHub Actions for building and pushing images, and a custom script for automated deployments.</p>
<h3>1. Setting Up GitHub Actions</h3>
<p>Create <code>.github/workflows/deploy.yml</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">Push</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">Image</span>

<span class="n">on</span><span class="o">:</span>
<span class="w">  </span><span class="n">push</span><span class="o">:</span>
<span class="w">    </span><span class="n">branches</span><span class="o">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">main</span>

<span class="n">jobs</span><span class="o">:</span>
<span class="w">  </span><span class="n">build</span><span class="o">-</span><span class="n">and</span><span class="o">-</span><span class="n">push</span><span class="o">:</span>
<span class="w">    </span><span class="n">runs</span><span class="o">-</span><span class="n">on</span><span class="o">:</span><span class="w"> </span><span class="n">ubuntu</span><span class="o">-</span><span class="n">latest</span>

<span class="w">    </span><span class="n">steps</span><span class="o">:</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Checkout</span>
<span class="w">      </span><span class="n">uses</span><span class="o">:</span><span class="w"> </span><span class="n">actions</span><span class="o">/</span><span class="n">checkout</span><span class="err">@</span><span class="n">v4</span>

<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Log</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">Hub</span>
<span class="w">      </span><span class="n">uses</span><span class="o">:</span><span class="w"> </span><span class="n">docker</span><span class="o">/</span><span class="n">login</span><span class="o">-</span><span class="n">action</span><span class="err">@</span><span class="n">v3</span>
<span class="w">      </span><span class="k">with</span><span class="o">:</span>
<span class="w">        </span><span class="n">username</span><span class="o">:</span><span class="w"> </span><span class="n">$</span><span class="o">{{</span><span class="w"> </span><span class="n">secrets</span><span class="o">.</span><span class="na">DOCKER_USERNAME</span><span class="w"> </span><span class="o">}}</span>
<span class="w">        </span><span class="n">password</span><span class="o">:</span><span class="w"> </span><span class="n">$</span><span class="o">{{</span><span class="w"> </span><span class="n">secrets</span><span class="o">.</span><span class="na">DOCKER_PASSWORD</span><span class="w"> </span><span class="o">}}</span>

<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">Buildx</span>
<span class="w">      </span><span class="n">uses</span><span class="o">:</span><span class="w"> </span><span class="n">docker</span><span class="o">/</span><span class="n">setup</span><span class="o">-</span><span class="n">buildx</span><span class="o">-</span><span class="n">action</span><span class="err">@</span><span class="n">v3</span>

<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">Push</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">Image</span>
<span class="w">      </span><span class="n">uses</span><span class="o">:</span><span class="w"> </span><span class="n">docker</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">push</span><span class="o">-</span><span class="n">action</span><span class="err">@</span><span class="n">v6</span>
<span class="w">      </span><span class="k">with</span><span class="o">:</span>
<span class="w">        </span><span class="n">context</span><span class="o">:</span><span class="w"> </span><span class="o">.</span>
<span class="w">        </span><span class="n">platforms</span><span class="o">:</span><span class="w"> </span><span class="n">linux</span><span class="o">/</span><span class="n">arm64</span>
<span class="w">        </span><span class="n">push</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="n">tags</span><span class="o">:</span><span class="w"> </span><span class="n">my</span><span class="o">-</span><span class="n">username</span><span class="o">/</span><span class="n">my</span><span class="o">-</span><span class="n">image</span><span class="o">:</span><span class="n">latest</span>
</code></pre></div>

<h3>2. Automated Deployment Script</h3>
<p>Create a <code>deploy.sh</code> script on your server:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="nv">IMAGE</span><span class="o">=</span><span class="s2">&quot;my-username/my-image:latest&quot;</span>
<span class="nv">CONTAINER_NAME</span><span class="o">=</span><span class="s2">&quot;my-container-name&quot;</span>

<span class="c1"># Pull the latest image</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Pulling the latest image...&quot;</span>
docker<span class="w"> </span>pull<span class="w"> </span><span class="nv">$IMAGE</span>

<span class="c1"># Check if the container exists</span>
<span class="nv">CONTAINER_EXISTS</span><span class="o">=</span><span class="k">$(</span>docker<span class="w"> </span>ps<span class="w"> </span>-a<span class="w"> </span>--filter<span class="w"> </span><span class="s2">&quot;name=^/</span><span class="si">${</span><span class="nv">CONTAINER_NAME</span><span class="si">}</span>$<span class="s2">&quot;</span><span class="w"> </span>--format<span class="w"> </span><span class="s1">&#39;{{.Names}}&#39;</span><span class="k">)</span>

<span class="c1"># Check if the container is running</span>
<span class="nv">CONTAINER_RUNNING</span><span class="o">=</span><span class="k">$(</span>docker<span class="w"> </span>ps<span class="w"> </span>--filter<span class="w"> </span><span class="s2">&quot;name=^/</span><span class="si">${</span><span class="nv">CONTAINER_NAME</span><span class="si">}</span>$<span class="s2">&quot;</span><span class="w"> </span>--filter<span class="w"> </span><span class="s2">&quot;status=running&quot;</span><span class="w"> </span>--format<span class="w"> </span><span class="s1">&#39;{{.Names}}&#39;</span><span class="k">)</span>

<span class="c1"># Get the hash of the currently running image (if the container exists)</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CONTAINER_EXISTS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nv">CURRENT_IMAGE</span><span class="o">=</span><span class="k">$(</span>docker<span class="w"> </span>inspect<span class="w"> </span>--format<span class="o">=</span><span class="s1">&#39;{{.Image}}&#39;</span><span class="w"> </span><span class="nv">$CONTAINER_NAME</span><span class="k">)</span>
<span class="k">else</span>
<span class="w">  </span><span class="nv">CURRENT_IMAGE</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="k">fi</span>

<span class="c1"># Get the hash of the latest image</span>
<span class="nv">LATEST_IMAGE</span><span class="o">=</span><span class="k">$(</span>docker<span class="w"> </span>inspect<span class="w"> </span>--format<span class="o">=</span><span class="s1">&#39;{{.Id}}&#39;</span><span class="w"> </span><span class="nv">$IMAGE</span><span class="k">)</span>

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CONTAINER_RUNNING</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CURRENT_IMAGE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$LATEST_IMAGE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;The container is already running the latest image. No action needed.&quot;</span>
<span class="k">else</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Updating or starting the container...&quot;</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CONTAINER_EXISTS</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>docker<span class="w"> </span>stop<span class="w"> </span><span class="nv">$CONTAINER_NAME</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
<span class="w">    </span>docker<span class="w"> </span>rm<span class="w"> </span><span class="nv">$CONTAINER_NAME</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
<span class="w">  </span><span class="k">fi</span>

<span class="w">  </span>docker<span class="w"> </span>run<span class="w"> </span>--name<span class="w"> </span><span class="nv">$CONTAINER_NAME</span><span class="w"> </span>-d<span class="w"> </span>-p<span class="w"> </span><span class="m">8000</span>:8000<span class="w"> </span><span class="nv">$IMAGE</span>
<span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Deployment completed.&quot;</span>
<span class="k">fi</span>
</code></pre></div>

<h3>3. Setting Up the Cron Job</h3>
<p>To automatically check for image updates:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Make the deploy script executable</span>
chmod<span class="w"> </span>+x<span class="w"> </span>deploy.sh

<span class="c1"># Add to crontab (runs every 15 minutes)</span>
<span class="o">(</span>crontab<span class="w"> </span>-l<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="p">;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;*/15 * * * * /path/to/deploy.sh &gt;&gt; /var/log/deploy.log 2&gt;&amp;1&quot;</span><span class="o">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>crontab<span class="w"> </span>-
</code></pre></div>

<h2>Considerations</h2>
<ol>
<li>Always use specific image tags in production rather than <code>latest</code></li>
<li>Implement health checks in your container</li>
<li>Use Docker secrets for sensitive information</li>
<li>Implement proper logging and monitoring</li>
<li>Consider using Docker Compose for more complex applications</li>
</ol>
  </article>
  </main>
</body>
</html>