<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />
  <title>HTML Form and JSON for single endpoint in FastAPI - Max Scheijen</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" href="../../theme/css/main.css" type="text/css" />
  <link rel="stylesheet" href="../../theme/css/styles.css" type="text/css" />
  <link rel="icon" type="image/png" sizes="16x16" href="../../theme/images/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../../theme/images/favicon-32x32.png">
  
  <link href="../../feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Max Scheijen - Flux ATOM" />
</head>
<body>
  <header>
    <a href="../../index.html">
      <svg fill="#000000" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="64px" height="64px" viewBox="0 0 114.84 114.84" xml:space="preserve" transform="rotate(180)" stroke="#000000" stroke-width="0.00114838"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC" stroke-width="1.607732"></g><g id="SVGRepo_iconCarrier"> <g> <path d="M114.822,83.667c0.005-0.003,0.011-0.005,0.016-0.008l-0.242-0.438l-0.174-0.469c-2.889,1.074-5.479,1.014-7.918-0.184 c-7.797-3.829-12.357-18.479-16.769-32.646c-4.267-13.702-8.295-26.646-15.083-28.488c-2.775-0.755-5.739,0.351-9.064,3.382 c-4.777,4.55-9.23,14.32-13.539,23.769C46.907,59.866,41.59,71.53,36.476,72.012c-3.446,0.344-6.995-4.27-10.74-9.134 c-6.261-8.13-14.054-18.248-25.66-10.945l0.229,0.365c-0.084,0.058-0.167,0.105-0.251,0.165l0.24,0.339 c-0.087,0.066-0.173,0.121-0.26,0.189l0.249,0.316c-0.089,0.074-0.178,0.136-0.267,0.213l0.254,0.293 c-0.09,0.082-0.18,0.15-0.27,0.235l0.686,0.729c2.635-2.484,5.091-3.456,7.498-2.976c6.335,1.265,11.459,12.705,15.979,22.798 c4.567,10.196,8.524,19.032,13.547,19.032c0.11,0,0.221-0.004,0.333-0.013c7.147-0.553,9.792-10.111,12.855-21.179 c2.173-7.854,4.636-16.753,9.091-23.108c3.963-5.409,7.5-7.907,10.817-7.629c5.937,0.494,10.636,9.831,15.611,19.717 c5.268,10.469,10.717,21.292,18.522,23.691c3.108,0.956,6.427,0.473,9.86-1.432c0.002,0,0.004-0.001,0.006-0.002l0,0 C114.811,83.673,114.817,83.671,114.822,83.667L114.822,83.667z M24.531,69.191c4.388,7.786,8.159,14.507,12.775,14.122 c6.434-0.546,10.442-11.369,14.686-22.826c3.227-8.712,6.564-17.721,11.146-23.053c3.447-4.012,6.49-5.736,9.291-5.266 c6.006,1.004,10.359,11.948,14.968,23.534c2.541,6.386,5.128,12.874,8.129,18.122c-2.808-4.604-5.325-10.21-7.8-15.729 C82.805,47.113,78.154,36.74,71.658,35.95c-3.406-0.418-6.973,1.813-10.88,6.815c-4.667,5.972-7.538,14.824-10.313,23.385 c-3.473,10.709-6.752,20.825-12.871,21.32c-4.2,0.358-8.168-7.59-12.355-15.985c-1.759-3.528-3.542-7.097-5.426-10.274 C21.469,63.768,23.034,66.537,24.531,69.191z M18.281,57.277c2.314,2.75,4.445,6.018,6.449,9.103 c4.243,6.528,7.916,12.162,12.208,11.781c6.056-0.541,10.657-11.662,15.528-23.435c3.739-9.035,7.604-18.378,12.241-23.236 c3.227-3.38,6.053-4.754,8.648-4.196c6.096,1.309,10.256,13.104,14.66,25.591c2.211,6.268,4.457,12.633,7.051,18.011 c-2.417-4.699-4.596-10.17-6.74-15.563c-4.715-11.855-9.169-23.053-15.73-24.15c-3.176-0.529-6.521,1.3-10.217,5.601 c-4.699,5.467-8.067,14.562-11.325,23.357c-4.13,11.15-8.032,21.685-13.833,22.177c-3.943,0.333-7.774-6.441-11.819-13.616 C23.207,64.808,20.868,60.667,18.281,57.277z M24.944,63.489c4.088,5.309,7.611,9.898,11.626,9.52 c5.69-0.536,10.887-11.937,16.389-24.006c4.268-9.362,8.681-19.042,13.31-23.452c3.044-2.775,5.701-3.804,8.121-3.149 c6.258,1.698,10.207,14.387,14.391,27.822c2.001,6.428,4.034,12.95,6.4,18.56c-2.241-4.952-4.246-10.63-6.223-16.231 c-4.501-12.759-8.752-24.81-15.395-26.236c-2.961-0.635-6.096,0.831-9.581,4.484c-4.767,4.993-8.668,14.424-12.441,23.544 c-4.752,11.484-9.241,22.333-14.693,22.819c-3.694,0.341-7.383-5.333-11.281-11.331c-2.567-3.948-5.333-8.194-8.471-11.336 C19.945,57.002,22.508,60.325,24.944,63.489z M70.889,40.706c-3.684-0.308-7.521,2.321-11.713,8.043 c-4.56,6.504-7.046,15.493-9.242,23.424c-2.962,10.705-5.521,19.95-11.968,20.448c-4.478,0.347-8.564-8.773-12.89-18.432 c-1.322-2.952-2.657-5.93-4.038-8.73c1.141,2.136,2.241,4.336,3.305,6.472c4.421,8.864,8.252,16.551,12.978,16.55 c0.117,0,0.235-0.005,0.354-0.015c6.783-0.549,10.008-10.493,13.741-22.009c2.749-8.478,5.592-17.245,10.15-23.077 c3.674-4.702,6.941-6.806,9.972-6.438c5.935,0.722,10.474,10.844,15.277,21.561c2.743,6.119,5.538,12.334,8.753,17.243 c-2.96-4.259-5.633-9.56-8.258-14.775C82.205,50.827,77.383,41.246,70.889,40.706z"></path> </g> </g></svg>
    </a>
  </header>
  <main>
        
  <h1>HTML Form and JSON for single endpoint in FastAPI</h1>
  <div class="meta">
    <p>Oct 05, 2024</p>
    <p></p>
  </div>
  <article>
  <p>A common challenge when building a FastAPI application is handling different content types, like <code>JSON</code> and <code>Form</code> data. Any many cases your API needs to support both formats, especially when dealing with web forms and modern front-end applications that often send json payloads.</p>
<p>This post demonstrates how to build a FastAPI application that handles and validates both JSON and from data inputs on a <strong>single endpoint</strong>.</p>
<h2>The Challenge: Handling Different Content Types</h2>
<p>By default, web browsers use <code>application/x-www-form-urlencoded</code> or <code>multipart/form-data</code> content types when submitting forms. On the other hand, APIs and modern front-ends typically send <code>application/json</code>. Our goal is to handle both efficiently and return appropriate responses.</p>
<p>To achieve this I'll:</p>
<ul>
<li>Use dependency injection in FastAPI to dynamically process the request type (form or json).</li>
<li>Validate the incoming data using Pydantic.</li>
<li>Handle errors gracefully, including invalid content types and validation errors.</li>
</ul>
<h2>Code Breakdown</h2>
<p>Let’s dive into each part of this code to understand how it works.</p>
<h3>Validation</h3>
<p>We define a Pydantic model <code>User</code> to enforce structure and validation on the incoming data. In this case, it expects a single field: <code>name</code>. This model will automatically validate the incoming data whether it comes from a form or a json body.</p>
<p>You can extend this model by adding more fields as needed.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div>

<h3>Request Type</h3>
<p>Below, I use the <code>request_type</code> function to dynamically handle both <code>JSON</code> and <code>Form</code> content types. The <code>Request</code> object is used to inspect the content type of the incoming request:</p>
<ul>
<li>If the content type is <code>application/x-www-form-urlencoded</code>, we treat it as form data and convert it to a dictionary using <code>await request.form()</code>.</li>
<li>If it’s <code>application/json</code>, we parse it into a dictionary using <code>await request.json()</code>.</li>
<li>If the content type is unsupported, we raise a <code>ValueError</code>.</li>
</ul>
<p>Later on the <code>request_type</code> function is injected into the route via FastAPI’s <code>Depends</code> feature.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">Request</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">request_type</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="c1"># Get content-type (json or form) from request</span>
    <span class="n">content_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">)</span>

    <span class="c1"># Convert form to dict</span>
    <span class="k">if</span> <span class="n">content_type</span> <span class="o">==</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">:</span>
        <span class="n">form_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form_data</span><span class="p">)</span>

    <span class="c1"># Convert json to dict</span>
    <span class="k">elif</span> <span class="n">content_type</span> <span class="o">==</span> <span class="s2">&quot;application/json&quot;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="c1"># Handle unsupported content types</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported content type: </span><span class="si">{</span><span class="n">content_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h3>Handle Request in Route</h3>
<p>This is the main route for handling incoming requests. The <code>data</code> returned by the <code>request_type</code> function is validated against the <code>User</code> model. If the validation succeeds, it means that the request body (whether JSON or form) is valid and contains the correct structure.</p>
<p>When the request’s content type is form data (<code>application/x-www-form-urlencoded</code>), we return a simple HTML response. This can of course be extended to return more complex HTML content based on your needs.</p>
<p>For JSON requests, the validated data is returned as the response.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">fastapi.responses</span> <span class="kn">import</span> <span class="n">JSONResponse</span><span class="p">,</span> <span class="n">HTMLResponse</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">root</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">request_type</span><span class="p">)):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Validate data using pydantic model</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># content-type is form, return HTML response</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HTMLResponse</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;p&gt;Hello, </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">!&lt;/p&gt;&quot;</span><span class="p">)</span>

        <span class="c1"># content-type not form return dict/json</span>
        <span class="k">return</span> <span class="n">user</span>

    <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Exception handling when form or json data is invalid</span>
        <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">json</span><span class="p">()),</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Handle unsupported content type</span>
        <span class="k">return</span> <span class="n">JSONResponse</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">415</span><span class="p">,</span>  <span class="c1"># Unsupported Media Type</span>
        <span class="p">)</span>
</code></pre></div>

<p>If the data doesn’t meet the Pydantic model’s validation rules, a <code>ValidationError</code> is raised, and a <code>400 Bad Request</code> error with the detailed validation errors is returned as a JSON response.</p>
<p>When the content type is unsupported, we catch the <code>ValueError</code> and return a <code>415 Unsupported Media Type</code> error with a descriptive message.</p>
<h2>Testing</h2>
<p>We can now make a request using a json body or a form to the same endpoint</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>--location<span class="w"> </span><span class="s1">&#39;http://127.0.0.1:8000 &#39;</span><span class="w"> </span><span class="se">\</span>
--header<span class="w"> </span><span class="s1">&#39;Content-Type: application/json&#39;</span><span class="w"> </span><span class="se">\</span>
--data<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;name&quot;: &quot;John Doe&quot;</span>
<span class="s1">}&#39;</span>
</code></pre></div>

<p>This will return the following json response.</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;John Doe&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p>We can also make a request using a form</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>--location<span class="w"> </span><span class="s1">&#39;http://127.0.0.1:8000 &#39;</span><span class="w"> </span><span class="se">\</span>
--header<span class="w"> </span><span class="s1">&#39;Content-Type: application/x-www-form-urlencoded&#39;</span><span class="w"> </span><span class="se">\</span>
--data-urlencode<span class="w"> </span><span class="s1">&#39;name=John Doe&#39;</span>
</code></pre></div>

<p>This results in a HTML string</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Hello, John Doe!<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</code></pre></div>

<p>When incorrect fields are specified this will result in a nice pydantic validation error response.</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>--location<span class="w"> </span><span class="s1">&#39;http://127.0.0.1:8000 &#39;</span><span class="w"> </span><span class="se">\</span>
--header<span class="w"> </span><span class="s1">&#39;Content-Type: application/x-www-form-urlencoded&#39;</span><span class="w"> </span><span class="se">\</span>
--data-urlencode<span class="w"> </span><span class="s1">&#39;user=John Doe&#39;</span>
</code></pre></div>

<p>The incorrect field <code>user</code> is used this will result in the following response</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;missing&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;loc&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;name&quot;</span>
<span class="w">        </span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;msg&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Field required&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;input&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;John Doe&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://errors.pydantic.dev/2.6/v/missing&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">]</span>
</code></pre></div>

<h2>Benefits</h2>
<p>This pattern allows for seamlessly processing both form and JSON data, making our API more flexible.</p>
<p>It also leverages Pydantic’s integration with FastAPI ensures that incoming json or form data is validated automatically based on the schema we define.</p>
<p>Unsupported content types and validation errors are handled gracefully, providing clear error messages to the client.</p>
<p>By using dependency injection (<code>Depends</code>), the code remains modular. The logic for handling and converting request data is abstracted away, making the route handler simpler and more readable.</p>
<h2>Links</h2>
<p>[[rest]] [[api]] [[python]] [[fastapi]]</p>
  </article>
  </main>
    <footer>
        <h2>Follow</h2>
        <p class="compact">
            Follow me on <a href="/feeds/all-en.atom.xml">RSS</a>,
            <a target="_blank" rel="me" href="https://github.com/maxscheijen">GitHub</a>,
            <a target="_blank" rel="me" href="https://linkedin.com/in/max-scheijen/">LinkedIn</a>,
            <a target="_blank" rel="me" href="https://bsky.app/profile/maxscheijen.bsky.social">BlueSky</a>,
            <a href="../../about"> or more about me</a>.
        </p>
    </footer>
</body>
</html>